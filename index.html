<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Portal FPS With View</title>
<style>
body { margin: 0; overflow: hidden; }
canvas { display: block; }
</style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/PointerLockControls.js"></script>

<script>

let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// FPS Controls
let controls = new THREE.PointerLockControls(camera, document.body);
document.body.addEventListener("click", () => controls.lock());
scene.add(controls.getObject());

// Lighting
scene.add(new THREE.HemisphereLight(0xffffff, 0x444444));

// Floor
let floor = new THREE.Mesh(
    new THREE.PlaneGeometry(100,100),
    new THREE.MeshStandardMaterial({color:0x222222})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// Portal Render Targets
let renderTargetA = new THREE.WebGLRenderTarget(512,512);
let renderTargetB = new THREE.WebGLRenderTarget(512,512);

// Portal Cameras
let portalCameraA = new THREE.PerspectiveCamera(75,1,0.1,1000);
let portalCameraB = new THREE.PerspectiveCamera(75,1,0.1,1000);

// Portal Materials
let portalMaterialA = new THREE.MeshBasicMaterial({map: renderTargetA.texture});
let portalMaterialB = new THREE.MeshBasicMaterial({map: renderTargetB.texture});

// Portal Meshes
let portalGeo = new THREE.PlaneGeometry(3,5);

let portalA = new THREE.Mesh(portalGeo, portalMaterialA);
portalA.position.set(0,2,-10);
scene.add(portalA);

let portalB = new THREE.Mesh(portalGeo, portalMaterialB);
portalB.position.set(0,15,0);
portalB.rotation.x = -Math.PI/2;
scene.add(portalB);

// Simple cube for depth reference
let cube = new THREE.Mesh(
    new THREE.BoxGeometry(2,2,2),
    new THREE.MeshStandardMaterial({color:0x00ff00})
);
cube.position.set(5,2,-15);
scene.add(cube);

// Player physics
let velocity = new THREE.Vector3();
let gravity = -20;
let maxVelocity = 30;
let canJump = false;
let keys = {};

document.addEventListener("keydown", e => keys[e.code]=true);
document.addEventListener("keyup", e => keys[e.code]=false);

function updatePlayer(delta){

    let direction = new THREE.Vector3(
        Number(keys["KeyD"]) - Number(keys["KeyA"]),
        0,
        Number(keys["KeyS"]) - Number(keys["KeyW"])
    );

    direction.normalize();

    if(direction.length()>0){
        let moveDir = new THREE.Vector3();
        controls.getDirection(moveDir);
        moveDir.y = 0;
        moveDir.normalize();

        let right = new THREE.Vector3();
        right.crossVectors(camera.up, moveDir).normalize();

        velocity.add(moveDir.multiplyScalar(-direction.z*10*delta));
        velocity.add(right.multiplyScalar(direction.x*10*delta));
    }

    velocity.y += gravity*delta;

    if(keys["Space"] && canJump){
        velocity.y = 8;
        canJump = false;
    }

    if(velocity.length()>maxVelocity){
        velocity.normalize().multiplyScalar(maxVelocity);
    }

    controls.getObject().position.addScaledVector(velocity,delta);

    if(controls.getObject().position.y<2){
        velocity.y=0;
        controls.getObject().position.y=2;
        canJump=true;
    }
}

function updatePortalCameras(){

    // Mirror player position relative to portals
    let playerPos = controls.getObject().position.clone();

    let offsetA = playerPos.clone().sub(portalA.position);
    portalCameraB.position.copy(portalB.position.clone().add(offsetA));
    portalCameraB.quaternion.copy(camera.quaternion);

    let offsetB = playerPos.clone().sub(portalB.position);
    portalCameraA.position.copy(portalA.position.clone().add(offsetB));
    portalCameraA.quaternion.copy(camera.quaternion);

    // Render views
    renderer.setRenderTarget(renderTargetA);
    renderer.render(scene, portalCameraB);

    renderer.setRenderTarget(renderTargetB);
    renderer.render(scene, portalCameraA);

    renderer.setRenderTarget(null);
}

let clock = new THREE.Clock();

function animate(){
    requestAnimationFrame(animate);
    let delta = clock.getDelta();

    updatePlayer(delta);
    updatePortalCameras();

    renderer.render(scene,camera);
}

animate();

</script>
</body>
</html>
