<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Portal Engine</title>
<style>
body { margin:0; overflow:hidden; }
canvas { display:block; }
</style>
</head>
<body>

<script type="module">

import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js';
import { PointerLockControls } from 'https://unpkg.com/three@0.158.0/examples/jsm/controls/PointerLockControls.js';

let scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

let camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

let controls = new PointerLockControls(camera, document.body);
document.body.addEventListener("click", ()=>controls.lock());
scene.add(controls.getObject());

scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));

// Floor
let floor = new THREE.Mesh(
    new THREE.PlaneGeometry(100,100),
    new THREE.MeshStandardMaterial({color:0x222222})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// Some walls
for(let i=0;i<5;i++){
    let wall = new THREE.Mesh(
        new THREE.BoxGeometry(10,10,1),
        new THREE.MeshStandardMaterial({color:0x555555})
    );
    wall.position.set(i*12-24,5,-20);
    scene.add(wall);
}

// Portal Setup
function createPortal(color){
    let rt = new THREE.WebGLRenderTarget(512,512);
    let cam = new THREE.PerspectiveCamera(75,1,0.1,1000);
    let mat = new THREE.MeshBasicMaterial({map:rt.texture});
    let mesh = new THREE.Mesh(new THREE.PlaneGeometry(3,5), mat);
    scene.add(mesh);
    return {mesh, cam, rt};
}

let portalA = createPortal(0x00aaff);
let portalB = createPortal(0xff5500);

portalA.mesh.position.set(-5,2,-15);
portalB.mesh.position.set(5,2,-15);

let activeRecursionDepth = 2;

// Player physics
let velocity = new THREE.Vector3();
let gravity = -20;
let maxVelocity = 35;
let keys = {};
let canJump=false;

document.addEventListener("keydown",e=>keys[e.code]=true);
document.addEventListener("keyup",e=>keys[e.code]=false);

function updatePlayer(dt){

    let dir = new THREE.Vector3(
        Number(keys["KeyD"])-Number(keys["KeyA"]),
        0,
        Number(keys["KeyS"])-Number(keys["KeyW"])
    ).normalize();

    if(dir.length()>0){
        let forward = new THREE.Vector3();
        controls.getDirection(forward);
        forward.y=0;
        forward.normalize();

        let right = new THREE.Vector3();
        right.crossVectors(camera.up, forward).normalize();

        velocity.add(forward.multiplyScalar(-dir.z*12*dt));
        velocity.add(right.multiplyScalar(dir.x*12*dt));
    }

    velocity.y += gravity*dt;

    if(keys["Space"] && canJump){
        velocity.y = 8;
        canJump=false;
    }

    if(velocity.length()>maxVelocity){
        velocity.normalize().multiplyScalar(maxVelocity);
    }

    controls.getObject().position.addScaledVector(velocity,dt);

    if(controls.getObject().position.y<2){
        velocity.y=0;
        controls.getObject().position.y=2;
        canJump=true;
    }

    checkPortalTeleport();
}

// Teleportation
function checkPortalTeleport(){
    let p = controls.getObject().position;

    if(p.distanceTo(portalA.mesh.position)<1.5){
        teleport(portalA,portalB);
    }
    if(p.distanceTo(portalB.mesh.position)<1.5){
        teleport(portalB,portalA);
    }
}

function teleport(from,to){
    let offset = controls.getObject().position.clone().sub(from.mesh.position);
    controls.getObject().position.copy(to.mesh.position.clone().add(offset));
}

// Recursive portal rendering (limited depth)
function renderPortal(from,to,depth){
    if(depth<=0) return;

    let playerPos = controls.getObject().position.clone();
    let offset = playerPos.clone().sub(from.mesh.position);

    to.cam.position.copy(to.mesh.position.clone().add(offset));
    to.cam.quaternion.copy(camera.quaternion);

    renderer.setRenderTarget(from.rt);
    renderer.render(scene,to.cam);
    renderer.setRenderTarget(null);
}

let clock = new THREE.Clock();

function animate(){
    requestAnimationFrame(animate);
    let dt = clock.getDelta();

    updatePlayer(dt);

    renderPortal(portalA,portalB,activeRecursionDepth);
    renderPortal(portalB,portalA,activeRecursionDepth);

    renderer.render(scene,camera);
}

animate();

</script>
</body>
</html>
